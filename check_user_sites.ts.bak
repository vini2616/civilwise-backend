import mongoose from 'mongoose';
import User from './src/models/User';
import Site from './src/models/Site';

async function checkUsers() {
    try {
        console.log('Connecting to MongoDB...');
        await mongoose.connect('mongodb://127.0.0.1:27017/vini_app');
        console.log('MongoDB Connected');

        // Find all users who are NOT Owners
        const users = await User.find({ role: { $ne: 'Owner' } });

        console.log(`Found ${users.length} non-owner users.`);

        for (const user of users) {
            console.log('---------------------------------------------------');
            console.log(`User: ${user.name} (${user.username})`);
            console.log(`Role: ${user.role}`);
            console.log(`Permission: ${user.permission}`);
            console.log(`Assigned Sites (Count: ${user.sites ? user.sites.length : 0}):`, user.sites);

            // Check if they have access to sites they shouldn't
            if (user.sites && user.sites.length > 0) {
                const sites = await Site.find({ _id: { $in: user.sites } });
                console.log('Site Details:', sites.map(s => `${s.name} (${s._id})`));
            }
        }

    } catch (error) {
        console.error('Error:', error);
    } finally {
        await mongoose.disconnect();
        console.log('Disconnected');
        process.exit(0);
    }
}

checkUsers();
